
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum AI Trader - Dashboard Perfetta</title>
    <!-- üéØ CHART.JS REALE - ORA LO USIAMO DAVVERO! -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card h2 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 5px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-weight: bold;
            color: #00ccff;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #ffaa00; }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            height: 400px;
        }
        
        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .position-card {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #00ff88;
        }
        
        .position-card.negative { border-left-color: #ff4444; }
        
        .refresh-info {
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-size: 0.9em;
        }
        
        .market-sentiment {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .sentiment-fear { background: #ff4444; color: white; }
        .sentiment-greed { background: #00ff88; color: black; }
        .sentiment-neutral { background: #ffaa00; color: black; }
        
        .error-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff4444;
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 9999;
            font-weight: bold;
        }
        
        .warning-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ffaa00;
            color: black;
            padding: 15px;
            text-align: center;
            z-index: 9999;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .loading { animation: pulse 1.5s infinite; }
        .offline { opacity: 0.6; }
    </style>
</head>
<body>
    <div id="errorBanner" style="display: none;"></div>
    <div id="warningBanner" style="display: none;"></div>
    
    <div class="container">
        <div class="header">
            <h1>ü§ñ QUANTUM AI TRADER</h1>
            <p>Dashboard Perfetta - Monitoraggio in Tempo Reale</p>
            <div id="lastUpdate" class="refresh-info"></div>
        </div>
        
        <div class="stats-grid">
            <!-- Performance Card -->
            <div class="card">
                <h2>üìà Performance</h2>
                <div id="performanceStats">
                    <div class="stat-item">
                        <span>Trade Totali:</span>
                        <span class="stat-value" id="totalTrades">0</span>
                    </div>
                    <div class="stat-item">
                        <span>P&L Medio:</span>
                        <span class="stat-value" id="avgPnl">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Win Rate:</span>
                        <span class="stat-value" id="winRate">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Cicli Eseguiti:</span>
                        <span class="stat-value" id="cycleCount">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Portfolio Card -->
            <div class="card">
                <h2>üí∞ Portfolio</h2>
                <div id="portfolioStats">
                    <div class="stat-item">
                        <span>Valore Totale:</span>
                        <span class="stat-value" id="totalValue">$0</span>
                    </div>
                    <div class="stat-item">
                        <span>Cash Disponibile:</span>
                        <span class="stat-value" id="cashBalance">$0</span>
                    </div>
                    <div class="stat-item">
                        <span>Esposizione:</span>
                        <span class="stat-value" id="exposure">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Posizioni Attive:</span>
                        <span class="stat-value" id="activePositions">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Mercato Card -->
            <div class="card">
                <h2>üåê Mercato</h2>
                <div id="marketStats">
                    <div class="stat-item">
                        <span>Fear & Greed:</span>
                        <span class="stat-value" id="fearGreed">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Sentiment:</span>
                        <span id="sentiment" class="market-sentiment sentiment-neutral">Neutral</span>
                    </div>
                    <div class="stat-item">
                        <span>BTC Dominance:</span>
                        <span class="stat-value" id="btcDominance">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Stato Sistema:</span>
                        <span class="stat-value positive" id="systemStatus">ONLINE</span>
                    </div>
                </div>
            </div>
            
            <!-- Risk Management Card -->
            <div class="card">
                <h2>üõ°Ô∏è Risk Management</h2>
                <div id="riskStats">
                    <div class="stat-item">
                        <span>Esposizione Attuale:</span>
                        <span class="stat-value" id="currentExposure">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Esposizione Max:</span>
                        <span class="stat-value" id="maxExposure">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Take Profit:</span>
                        <span class="stat-value" id="takeProfit">0%</span>
                    </div>
                    <div class="stat-item">
                        <span>Stop Loss:</span>
                        <span class="stat-value" id="stopLoss">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- üéØ GRAFICO CHART.JS REALE -->
        <div class="chart-container">
            <h2>üìä Performance Cumulative (Chart.js)</h2>
            <canvas id="performanceChart"></canvas>
        </div>
        
        <!-- Posizioni Attive -->
        <div class="card">
            <h2>üéØ Posizioni Attive</h2>
            <div id="activePositionsContainer" class="positions-grid">
                <div class="loading">Caricamento posizioni...</div>
            </div>
        </div>
        
        <!-- Ultimi Trade -->
        <div class="card">
            <h2>üîÑ Ultimi Trade</h2>
            <div id="recentTradesContainer">
                <div class="loading">Caricamento trade recenti...</div>
            </div>
        </div>
    </div>

    <script>
        // üéØ VARIABILI GLOBALI PER GESTIONE STATO
        let updateInterval;
        let chart;
        let consecutiveErrors = 0;
        const MAX_CONSECUTIVE_ERRORS = 3;
        let lastChartUpdate = 0;
        const CHART_UPDATE_INTERVAL = 30000; // 30 secondi
        
        // üéØ INIZIALIZZAZIONE CHART.JS
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'P&L Cumulative (%)',
                        data: [],
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#cccccc' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: '#cccccc' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        // üéØ AGGIORNAMENTO DASHBOARD CON GESTIONE ERRORI COMPLETA
        function updateDashboard() {
            fetch('/api/stats')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    consecutiveErrors = 0; // Reset errori consecutivi
                    hideErrorBanner();
                    
                    // üéØ PASSA TUTTI I DATI NECESSARI - RISOLTO PROBLEMA RIFERIMENTO
                    updatePerformance(data.performance, data.cycle_count);
                    updatePortfolio(data.portfolio);
                    updateMarket(data.market_data);
                    updateRisk(data.risk_metrics);
                    updatePositions(data.portfolio.positions);
                    updateRecentTrades(data.recent_trades);
                    updateSystemInfo(data);
                    
                    // üéØ AGGIORNA GRAFICO OGNI 30s - LOGICA CHIARA
                    const now = Date.now();
                    if (now - lastChartUpdate > CHART_UPDATE_INTERVAL) {
                        updateChart(data.performance?.chart_data);
                        lastChartUpdate = now;
                    }
                    
                    document.getElementById('lastUpdate').textContent = 
                        `Ultimo aggiornamento: ${new Date().toLocaleTimeString()}`;
                    
                    // Gestione stato offline/online
                    if (!data.engine_online) {
                        showWarningBanner('‚ö†Ô∏è Bot disconnesso - Tentativo riconnessione...');
                        document.body.classList.add('offline');
                    } else {
                        document.body.classList.remove('offline');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Errore fetch:', error);
                    consecutiveErrors++;
                    
                    // üéØ GESTIONE ERRORI VISIBILE ALL'UTENTE
                    showErrorBanner(`Errore connessione: ${error.message}`);
                    
                    document.getElementById('systemStatus').textContent = 'OFFLINE';
                    document.getElementById('systemStatus').className = 'stat-value negative';
                    
                    // Stop aggiornamenti se troppi errori consecutivi
                    if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
                        showErrorBanner('‚ùå Connessione persa - Ricarica la pagina');
                        if (updateInterval) {
                            clearInterval(updateInterval);
                        }
                    }
                });
        }
        
        // üéØ FUNZIONI AGGIORNAMENTO CON PARAMETRI CORRETTI
        function updatePerformance(performance, cycleCount) {
            if (performance?.error) {
                document.getElementById('performanceStats').innerHTML = 
                    `<div class="stat-item"><span>Errore:</span><span class="negative">${performance.error}</span></div>`;
                return;
            }
            
            document.getElementById('totalTrades').textContent = performance?.total_trades || 0;
            document.getElementById('avgPnl').textContent = (performance?.avg_pnl || 0) + '%';
            document.getElementById('avgPnl').className = 'stat-value ' + 
                ((performance?.avg_pnl || 0) >= 0 ? 'positive' : 'negative');
            document.getElementById('winRate').textContent = (performance?.win_rate || 0) + '%';
            document.getElementById('cycleCount').textContent = cycleCount || 0;
        }
        
        function updatePortfolio(portfolio) {
            if (portfolio?.error) {
                document.getElementById('portfolioStats').innerHTML = 
                    `<div class="stat-item"><span>Errore:</span><span class="negative">${portfolio.error}</span></div>`;
                return;
            }
            
            document.getElementById('totalValue').textContent = '$' + (portfolio?.total_value || 0);
            document.getElementById('cashBalance').textContent = '$' + (portfolio?.cash || 0);
            document.getElementById('exposure').textContent = (portfolio?.exposure_pct || 0) + '%';
            document.getElementById('activePositions').textContent = portfolio?.position_count || 0;
        }
        
        function updateMarket(market) {
            if (market?.error) {
                document.getElementById('marketStats').innerHTML = 
                    `<div class="stat-item"><span>Errore:</span><span class="negative">${market.error}</span></div>`;
                return;
            }
            
            document.getElementById('fearGreed').textContent = market?.fear_greed || 0;
            
            const sentimentElem = document.getElementById('sentiment');
            const sentiment = market?.market_sentiment || 'Neutral';
            sentimentElem.textContent = sentiment;
            sentimentElem.className = 'market-sentiment sentiment-' + 
                (sentiment.toLowerCase().includes('fear') ? 'fear' : 
                 sentiment.toLowerCase().includes('greed') ? 'greed' : 'neutral');
            
            document.getElementById('btcDominance').textContent = (market?.btc_dominance || 0) + '%';
        }
        
        function updateRisk(risk) {
            if (risk?.error) {
                document.getElementById('riskStats').innerHTML = 
                    `<div class="stat-item"><span>Errore:</span><span class="negative">${risk.error}</span></div>`;
                return;
            }
            
            document.getElementById('currentExposure').textContent = (risk?.current_exposure || 0) + '%';
            document.getElementById('maxExposure').textContent = (risk?.max_exposure || 0) + '%';
            document.getElementById('takeProfit').textContent = (risk?.take_profit || 0) + '%';
            document.getElementById('stopLoss').textContent = (risk?.stop_loss || 0) + '%';
        }
        
        function updatePositions(positions) {
            const container = document.getElementById('activePositionsContainer');
            
            if (!positions || positions.length === 0) {
                container.innerHTML = '<div class="position-card">Nessuna posizione attiva</div>';
                return;
            }
            
            container.innerHTML = positions.map(position => `
                <div class="position-card ${(position.pnl_pct || 0) < 0 ? 'negative' : ''}">
                    <div style="font-weight: bold; margin-bottom: 8px;">${position.symbol}</div>
                    <div style="font-size: 0.9em;">
                        <div>Quantit√†: ${position.quantity}</div>
                        <div>Entry: $${position.entry_price}</div>
                        <div>Current: $${position.current_price}</div>
                        <div>Valore: $${position.value}</div>
                        <div>P&L: <span class="${(position.pnl_pct || 0) >= 0 ? 'positive' : 'negative'}">${position.pnl_pct}%</span></div>
                        <div>Giorni: ${position.holding_days}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateRecentTrades(trades) {
            const container = document.getElementById('recentTradesContainer');
            
            if (!trades || trades.length === 0 || (trades.length === 1 && trades[0].error)) {
                container.innerHTML = '<div>Nessun trade recente</div>';
                return;
            }
            
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                                <th style="padding: 8px; text-align: left;">Ora</th>
                                <th style="padding: 8px; text-align: left;">Asset</th>
                                <th style="padding: 8px; text-align: left;">Azione</th>
                                <th style="padding: 8px; text-align: right;">Importo</th>
                                <th style="padding: 8px; text-align: right;">P&L</th>
                                <th style="padding: 8px; text-align: left;">Motivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trades.map(trade => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <td style="padding: 8px;">${trade.timestamp}</td>
                                    <td style="padding: 8px;">${trade.symbol}</td>
                                    <td style="padding: 8px;">
                                        <span class="${trade.action === 'BUY' ? 'positive' : 'negative'}">
                                            ${trade.action}
                                        </span>
                                    </td>
                                    <td style="padding: 8px; text-align: right;">$${trade.amount}</td>
                                    <td style="padding: 8px; text-align: right;">
                                        ${trade.profit_pct !== null && trade.profit_pct !== undefined ? 
                                            `<span class="${trade.profit_pct >= 0 ? 'positive' : 'negative'}">
                                                ${trade.profit_pct}%
                                            </span>` : 
                                            '-'
                                        }
                                    </td>
                                    <td style="padding: 8px; font-size: 0.8em;">${trade.reason}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function updateSystemInfo(data) {
            document.getElementById('systemStatus').textContent = data.system_status;
            document.getElementById('systemStatus').className = 'stat-value ' + 
                (data.system_status === 'ONLINE' ? 'positive' : 'negative');
        }
        
        // üéØ AGGIORNA GRAFICO CHART.JS
        function updateChart(chartData) {
            if (!chartData || !chartData.labels || !chartData.cumulative) {
                return;
            }
            
            chart.data.labels = chartData.labels;
            chart.data.datasets[0].data = chartData.cumulative;
            chart.update('none'); // Aggiorna senza animazione
        }
        
        // üéØ GESTIONE BANNER ERRORI
        function showErrorBanner(message) {
            const banner = document.getElementById('errorBanner');
            banner.textContent = message;
            banner.className = 'error-banner';
            banner.style.display = 'block';
        }
        
        function showWarningBanner(message) {
            const banner = document.getElementById('warningBanner');
            banner.textContent = message;
            banner.className = 'warning-banner';
            banner.style.display = 'block';
        }
        
        function hideErrorBanner() {
            document.getElementById('errorBanner').style.display = 'none';
            document.getElementById('warningBanner').style.display = 'none';
        }
        
        // üéØ INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            updateDashboard(); // Primo aggiornamento
            updateInterval = setInterval(updateDashboard, 5000); // Ogni 5 secondi
            
            // Auto-riconnessione se offline
            setInterval(() => {
                if (consecutiveErrors > 0 && consecutiveErrors < MAX_CONSECUTIVE_ERRORS) {
                    updateDashboard();
                }
            }, 15000); // Ogni 15 secondi se errore
        });
        
        // Pulizia quando la pagina viene chiusa
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
    