#!/bin/bash

echo "üöÄ QUANTUM TRADING SYSTEM - COMMAND MANAGER"
echo "==========================================="

case "$1" in
    "start")
        echo "‚ñ∂Ô∏è  Avvio Quantum Trader..."
        pkill -f "quantum_trader_production" 2>/dev/null
        sleep 2
        python3 quantum_trader_production.py &
        echo "‚úÖ Trader avviato in background"
        ;;
    "stop")
        echo "üõë Fermo tutto il sistema..."
        pkill -f "quantum_trader_production"
        pkill -f "quantum_dashboard"
        echo "‚úÖ Sistema fermato"
        ;;
    "dashboard")
        echo "üìä Avvio Dashboard..."
        pkill -f "quantum_dashboard" 2>/dev/null
        sleep 2
        python3 quantum_dashboard_ultimate.py
        ;;
    "status")
        echo "üìà STATO SISTEMA:"
        echo "-----------------"
        if pgrep -f "quantum_trader_production" > /dev/null; then
            echo "‚úÖ TRADER: Attivo (PID: $(pgrep -f quantum_trader_production))"
        else
            echo "‚ùå TRADER: Fermo"
        fi
        if pgrep -f "quantum_dashboard" > /dev/null; then
            echo "‚úÖ DASHBOARD: Attivo (http://localhost:8000)"
        else
            echo "‚ùå DASHBOARD: Fermo"
        fi
        ;;
    "logs")
        echo "üìã LOGS IN TEMPO REALE:"
        echo "-----------------------"
        if [ -f "production.log" ]; then
            tail -f production.log
        else
            echo "Nessun log trovato"
        fi
        ;;
    "performance")
        echo "üìä PERFORMANCE REPORT COMPLETO:"
        echo "================================"
        if [ -f "production.log" ] && [ -s "production.log" ]; then
            echo "üí∞ PORTAFOGLIO ATTUALE:"
            grep "Portfolio:" production.log | tail -1
            echo ""
            echo "üí∏ BALANCE LIQUIDO:"
            grep "Balance:" production.log | tail -1
            echo ""
            echo "üîÑ ULTIMI CICLI:"
            grep -E "(CICLO #|FINE CICLO)" production.log | tail -3
            echo ""
            echo "üìà DECISIONI TRADING:"
            grep -E "(HOLD|BUY|SELL) .*Score:" production.log | tail -6
            echo ""
            echo "üõ°Ô∏è STATO PROTEZIONI:"
            grep -E "(bloccato|protection)" production.log | tail -2
        else
            echo "üìù Log attivo - Trader in esecuzione"
            echo "üí° Il report si popoler√† al prossimo ciclo"
        fi
        ;;
    "database")
        echo "üóÑÔ∏è  DATABASE INFO:"
        echo "-----------------"
        if [ -f "trading_db.sqlite" ]; then
            size=$(du -h trading_db.sqlite | cut -f1)
            echo "Database: trading_db.sqlite ($size)"
            echo "Tabelle:"
            sqlite3 trading_db.sqlite ".tables" 2>/dev/null || echo "Database vuoto o non accessibile"
        else
            echo "‚ùå Database non trovato"
        fi
        ;;
    "clean")
        echo "üßπ Pulizia sistema..."
        pkill -f "quantum_trader_production"
        pkill -f "quantum_dashboard"
        rm -f production.log
        echo "‚úÖ Sistema pulito"
        ;;
    "backup")
        echo "üíæ Backup su GitHub..."
        if [ -f "$HOME/github_backup.sh" ]; then
            bash ~/github_backup.sh
        else
            echo "‚ùå File github_backup.sh non trovato in home directory"
            echo "üí° Crealo con: cat > ~/github_backup.sh"
        fi
        ;;
    "emergency")
        echo "üÜò COMANDI RIPRISTINO EMERGENZA:"
        echo "================================="
        echo "git clone https://github.com/LorenzoPacc/QuantumTradingSystem.git"
        echo "cd QuantumTradingSystem" 
        echo "./quantum_commands.sh start"
        echo ""
        echo "üìÅ Backup manuale:"
        echo "cp -r ~/trading_project/QuantumTradingSystem ~/backup_quantum_$(date +%Y%m%d)"
        ;;
    *)
        echo "Usage: ./quantum_commands.sh [command]"
        echo ""
        echo "COMANDI DISPONIBILI:"
        echo "  start       - Avvia trader completo"
        echo "  stop        - Ferma tutto il sistema" 
        echo "  dashboard   - Avvia dashboard"
        echo "  status      - Stato sistema"
        echo "  logs        - Logs in tempo reale"
        echo "  performance - Report performance COMPLETO"
        echo "  database    - Info database"
        echo "  clean       - Pulizia sistema"
        echo "  backup      - Backup su GitHub"
        echo "  emergency   - Comandi ripristino"
        echo ""
        echo "ESEMPI:"
        echo "  ./quantum_commands.sh start"
        echo "  ./quantum_commands.sh dashboard"
        echo "  ./quantum_commands.sh status"
        ;;
esac
